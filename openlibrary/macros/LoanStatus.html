$def with (page, ebook_text, user, current_and_available_loans, contributor, line_break = '')

$# TODO construct list of available formats from available_loans

$if current_and_available_loans:
  $ current_loans = current_and_available_loans[0]
  $ available_loans = current_and_available_loans[1]
$else:
  $ current_loans = []
  $ available_loans = []

$ wlsize = page.get_waitinglist_size()
$ waiting_loan = ctx.user and ctx.user.get_waiting_loan_for(page)

$if available_loans:
    $# When the book is available and there are people waiting for the book,
    $# don't allow anyone other than the first person in the waiting list to borrow the book.
    $if wlsize > 0 and (not waiting_loan or waiting_loan['status'] != 'available'):
        $ available_loans = []

$ user_loan = None
$if user:
    $for current_loan in current_loans:
        $if current_loan['user'] == user.key:
            $ user_loan = current_loan
            $ break

$ borrow_link = page.url() + '/borrow'

$if user_loan:
    <p style="padding-bottom:10px;"><a href="$borrow_link" title="Borrow from $contributor" class="borrow-btn borrow-link">Read/Return eBook</a><br />
    <span class="smaller">Checked out from $contributor</span></p>
$elif available_loans:
    <p style="padding-bottom:10px;"><a href="$borrow_link" title="Borrow from $contributor" class="borrow-btn borrow-link">Borrow eBook</a><br />
    <span class="smaller">in-browser, ePub, or PDF from $contributor</span></p>
$else:
    <p style="padding-bottom:10px;">
        <span class="smaller">eBook is checked out.</span>
        $ wlsize = page.get_waitinglist_size()
        $if waiting_loan:
           $ spot = ctx.user.get_waiting_loan_for(page)['position']
           $if spot == 1:
               <p>You are next on the waiting list:</p>
           $else:
               <p>You are #$(spot) of $(wlsize) on the waiting list:</p>

           <p><a href="$borrow_link" class="unwait-btn">Leave waiting list?</a></p>
           <br/>
        $else:
	   $if wlsize:
             <p>Readers waiting for this title: $(wlsize)</p>
	   $else:
	     <p>You'll be next in line:</p>
           <p><a href="$borrow_link" class="wait-btn">Join the waiting list?</a></p>
           <br/>
    </p>
