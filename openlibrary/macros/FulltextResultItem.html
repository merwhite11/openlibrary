$def with (doc, decorations=None, cta=True, availability=None, extra=None, attrs=None, rating=None, show_librarian_extras=False, include_dropper=False, blur=False, footer=None)

$code:
  max_rendered_authors = 9
  doc_type = (
    'infogami_work' if doc.get('type', {}).get('key') == '/type/work' else
    'infogami_edition' if doc.get('type', {}).get('key') == '/type/edition' else
    'solr_work' if not doc.get('editions') else
    'solr_edition'
  )

  selected_ed = doc
  if doc_type == 'solr_edition':
    selected_ed = doc.get('editions')[0]

  book_url = doc.url() if doc_type.startswith('infogami_') else doc.key
  if doc_type == 'solr_edition':
    work_edition_url = book_url + '?edition=' + urlquote('key:' + selected_ed.key)
  else:
    book_provider = get_book_provider(doc)
    if book_provider and doc_type.endswith('_work'):
      work_edition_url = book_url + '?edition=' + urlquote(book_provider.get_best_identifier_slug(doc))
    else:
      work_edition_url = book_url

  work_edition_all_url = work_edition_url
  if '?' in work_edition_url:
    work_edition_all_url += '&mode=all'
  else:
    work_edition_all_url += '?mode=all'

  edition_work = None
  if doc_type == 'infogami_edition' and 'works' in doc:
    edition_work = doc['works'][0]

  full_title = selected_ed.get('title', '') + (': ' + selected_ed.subtitle if selected_ed.get('subtitle') else '')
  if doc_type == 'infogami_edition' and edition_work:
    full_work_title = edition_work.get('title', '') + (': ' + edition_work.subtitle if edition_work.get('subtitle') else '')
  else:
    full_work_title = doc.get('title', '') + (': ' + doc.subtitle if doc.get('subtitle') else '')

<div class="fsi" itemscope itemtype="https://schema.org/Book" $:attrs>
  $ blur_cover = "bookcover--blur" if blur else ""
  $if 'log' in doc:
    <div class="feed-item">
      <a class="feed-item--patron" href="/people/$(doc['log']['username'])">
        <img src="/people/$(doc['log']['username'])/avatar" class="account-avatar account-avatar--sm account-avatar-fix">
        $doc['log']['username']
      </a> $_("added to")
      <a href="/people/$(doc['log']['username'])/books/$(doc['log']['shelf'].replace(' ', '-'))" class="feed-item--shelf">$doc['log']['shelf']</a> $datestr(doc['log']['updated'])
    </div>
  <div class="fsi__main">
    <div class="sri__bookcover-details">
      <span class="fsi__bookcover $blur_cover">
        $ cover = get_cover_url(selected_ed) or "/images/icons/avatar_book-sm.png"
        <a href="$work_edition_url"><img
                itemprop="image"
                src="$cover"
                alt="$_('Cover of: %(title)s', title=full_title)"
                title="$_('Cover of: %(title)s', title=full_title)"
        /></a>
      </span>

      <div class="fsi__book-details">
        <div class="fsi__title-author">
          <h3 class="fsi__book-title" itemprop="name">
            <a class="fsi__book-title-link" itemprop="url" data-ol-link-track="SearchInsideCard|BookClick" href="$work_edition_url">$full_title</a>
          </h3>
          <p class="fsi__book-author" itemprop="author" itemscope itemtype="https://schema.org/Organization">
            $ authors = None
            $if doc_type == 'infogami_work':
              $ authors = doc.get_authors()
            $elif doc_type == 'infogami_edition':
              $ authors = edition_work.get_authors() if edition_work else doc.get_authors()
            $elif doc_type.startswith('solr_'):
              $if 'authors' in doc:
                $ authors = doc['authors']
              $elif 'author_key' in doc:
                $ authors = [ { 'key': '/authors/' + key, 'name': name } for key, name in zip(doc['author_key'], doc['author_name']) ]
            $if not authors:
              <em>$_('Unknown author')</em>
            $else:
              $code:
                author_data = [
                  {
                    'name': a.get('name') or a.get('author', {}).get('name'),
                    'url': (a.get('url') or a.get('key') or a.get('author', {}).get('url') or a.get('author', {}).get('key'))
                  }
                  for a in authors
                ]
              $:macros.BookByline(author_data, limit=max_rendered_authors, overflow_url=work_edition_url, attrs='class="results"')
          </p>
      </div>
      $if extra:
        $:extra
      </div>

  </div>
  <div class="fsi__footer">

    <div class="searchResultItemCTA">
        $if decorations:
          $# should show reading log status widget if there is one in decorations, or read, or return, or leave waitlist
          <div class="decorations">
            $:decorations
          </div>

        <div class="searchResultItemCTA-lending">
          $if cta:
            $ selected_ed['availability'] = selected_ed.get('availability', {}) or doc.get('availability', {}) or availability or {}
            $:macros.LoanStatus(selected_ed, work_key=doc.key)
        </div>

        $if include_dropper:
          $ edition_key = None
          $if doc_type == 'solr_edition':
            $ edition_key = selected_ed.key
          $elif doc_type == 'infogami_edition':
            $ edition_key = doc.key
          $elif doc_type == 'solr_work':
            $ edition_key = doc.get('edition_key') and doc.get("edition_key")[0]
            $ edition_key = '/books/%s' % edition_key
          $:render_template('my_books/dropper', doc, edition_key=edition_key, async_load=True)

        $if rating:
          $:rating
    </div>

    $if footer:
      <hr />
      $:footer
  </div>
</div>
