$def with (items, key, counts, lists=None, user=None, logged_in_user=None, public=False, sort_order='desc', owners_page=False)

$# Displays a user's reading log
$# :param list items:
$# :param Literal['currently-reading', 'want-to-read', 'already-read', 'sponsorships', 'loans', 'waitlist', 'notes', 'observations'] key:
$# :param Dict[str: int] counts:
$# :param list? lists:
$# :param user:
$# :param bool public:

$ username = user.key.split('/')[-1]

$ current_page = int(input(page=1).page)
$ total_items = counts.get(key, None)

$ userDisplayName = user.displayname or ctx.user.displayname
$ userKey = user.key or ctx.user.key

$ header_title = unicode(render_template('account/readinglog_shelf_name', key)).strip()
$ breadcrumb = _("Reading Log")

$if not header_title:
  $if key == 'sponsorships':
    $ header_title = _("Sponsorships")
  $elif key == 'notes':
    $ header_title = _("Book Notes")
  $elif key == 'observations':
    $ header_title = _("Observations")
  $elif key == 'loans':
    $ header_title = _("Loans")
  $elif key == 'waitlist':
    $ header_title = _("Waiting List")
  $elif key == 'imports':
    $ header_title = _("Imports and Exports")
  $elif key == 'lists':
    $ header_title = _('My Lists')
  $elif key == 'list':
    $ header_title = items.get('name', 'List')
  $else:
    $ header_title = key
  $ breadcrumb = header_title

<div id="contentHead">
  <div id="mybooks">
    <div class="small sansserif grey account-settings-menu">
      <a href="$userKey">$userDisplayName</a> &raquo; $breadcrumb
    </div>
    <div>
    </div>
    <div>
      <h1 style="display:inline">
        $if not owners_page:
          $userDisplayName &raquo; $header_title
        $else:
          $header_title
      </h1>

      $if owners_page and key in ['currently-reading', 'already-read', 'want-to-read']:
        <a href="$ctx.path/stats" title="$('View stats about this shelf')">$_('Stats')</a>
    </div>

    $if owners_page:
      <h3>
        $if key == 'notes':
          $_('Your book notes are private and cannot be viewed by other patrons.')
        $elif key == 'observations':
          $_('Your book observations will be shared anonymously with other patrons.')
        $elif key in ['currently-reading', 'already-read', 'want-to-read']:
          $if public:
            $_('Your reading log is currently set to public')
            <button onclick="prompt('Copy share link to clipboard:', window.location.protocol + '//' + window.location.hostname + '/people/$(username)/books/$(key)');">Share</button> or
          $else:
            $_('Your reading log is currently set to private')
          &mdash;
          <a href="/account/privacy">$_('Manage your privacy settings')</a>
      </h3>

    <div class="mybooks">
      <div class="mybooks-menu">
        $if owners_page:
          <ul class="preset-lists">
            <li class="subsection">$_('My Loans')</li>
            <li>
              <a href="/account/loans" $('class=selected' if key == 'loans' else '')>
                $ loan_count = counts.get('loans', None)
                $_('Checked out')
                $if loan_count is not None:
                  ($loan_count)
              </a>
            </li>
            <li>
              <a href="/account/waitlist" $('class=selected' if key == 'waitlist' else '')>
                $ waiting_count = counts.get('waitlist', None)
                $_('Waitlist')
                $if waiting_count is not None:
                  ($waiting_count)
              </a>
            </li>
            <li>
              <a class="external-link" href="https://archive.org/account/?tab=loans#loans-history">Loan History</a>
            </li>
          </ul>
        $if public or owners_page:
          <ul class="preset-lists">
            <li class="subsection">$_('Reading Log')</li>
            <li><a href="/people/$username/books/currently-reading" $('class=selected' if key == 'currently-reading' else '')>$_('Currently Reading (%(count)d)', count=counts['currently-reading'])</a></li>
            <li><a href="/people/$username/books/want-to-read" $('class=selected' if key == 'want-to-read' else '')>$_('Want to Read (%(count)d)', count=counts['want-to-read'])</a></li>
            <li><a href="/people/$username/books/already-read" $('class=selected' if key == 'already-read' else '')>$_('Already Read (%(count)d)', count=counts['already-read'])</a></li>
          </ul>
        $if owners_page and ctx.user and ctx.user.in_sponsorship_beta():
          <!-- only show to owners -->
          <ul class="preset-lists">
            <li class="subsection">$_('Sponsorships')</li>
            $ sponsorship_count = ''
            $if counts.get('sponsorships', None):
              $ sponsorship_count = "(%d)" % counts['sponsorships']
            <li><a href="/people/$username/books/sponsorships" $('class=selected' if key == 'sponsorships' else '')>$_('Sponsoring') $sponsorship_count</a></li>
          </ul>
        $if owners_page:
          <ul class="booknotes-list">
            <li class="subsection">$_('Notes & Observations')</li>
            <li><a $('class=selected' if key=='notes' else '') href="/people/$username/books/notes">$_('My notes (%(count)d)', count=counts['notes'])</a></li>
            <li><a $('class=selected' if key=='observations' else '') href="/people/$username/books/observations">$_('My observations (%(count)d)', count=counts['observations'])</a></li>
          </ul>
          <ul class="import-export-lists">
            <li class="subsection">$_("Import / Export")</li>
            <li><a href="/account/import" $('class=selected' if key=='imports' else '')>$_("Import & Export Options")</a></li>
          </ul>
          <ul class="user-lists">
            <li class="subsection">$_('Lists')</li>
            <div class="list-overflow">
              $ class_list = 'list-link'
              $if key == 'lists':
                $ class_list = class_list + ' selected'
              <li><a href="/people/$username/lists" class="$class_list">$_('My Lists') ($(len(lists)))</a></li>
              $for lst in lists:
                $ list_id = lst.key.split('/')[-1]
                $ class_list = 'list-link'
                $if lst == items:
                  $ class_list = class_list + ' selected'
                <li><a class="$class_list" href="/people/$username/lists/$list_id">$lst['name'] ($(len(lst.seeds)))</a></li>
            </div>
          </ul>
      </div>
      <div class="mybooks-details">
        $if key == 'loans':
          $:render_template('account/loans', logged_in_user, items)
        $elif key == 'waitlist':
          $:render_template('account/waitlist', logged_in_user)
        $elif key == 'notes':
          $:render_template('account/notes', items, user, counts['notes'], page=current_page)
        $elif key == 'observations':
          $:render_template('account/observations', items, user, counts['observations'], page=current_page)
        $elif key == 'imports':
          $:render_template('account/import')
        $elif key == 'lists':
          $:render_template('lists/lists', items, lists, show_header=False)
        $elif key in {'currently-reading', 'want-to-read', 'already-read', 'sponsorships'}:
          $:render_template('account/reading_log', items, key, counts[key], owners_page, current_page, sort_order=sort_order, user=user)
        $else:
          $:render_template('type/list/view', items, check_owner=False, owns_page=True)
      </div>
    </div>
  </div>
</div>
