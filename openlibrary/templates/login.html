$def with (form)

$var title: $("Log In")

<div id="contentHead">
    <h1>$_("Log In")</h1>
</div>

<script type="text/javascript">
//\$().ready(passwordMask);
//\$().ready(validateForms);
//\$().ready(validateLogin);
</script>


<div id="migrateModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-x">&#x2715;</div>
      <div class="modal-icon">
        <img  src="https://archive.org/images/logo_arches.png"/>
      </div>
      <div class="modal-header-copy">
        <h2>Link Accounts</h2>
        <p class="modal-header-copy-a">Open Library now requires an <a class="service" href="https://archive.org">archive.org</a> account. Do you have one already?</p>
        <p class="modal-header-copy-b">Verify your <a class="service" href="https://archive.org">archive.org</a> credentials and proceed to login.</p>
        <p class="modal-header-copy-c">Choose a username for your new <a class="service" href="https://archive.org">archive.org</a> account.</p>
      </div>
    </div>

    <div class="modal-body">
      <ul class="modal-option">
        <li><a id="linkAccounts">Yes, connect my archive.org account.</a></li>
        <li><a id="createAccount">No, create one for me.</a></li>
      </ul>
      <div class="modal-create-form modal-form">
        <div class="formFields">
            <input type="text" id="connectEmail" autocomplete="off"
             name="createUsername" placeholder=""/>
        </div>
        <div>
          <button id="verifyAndCreate">Verify &amp; Create</button>
        </div>
      </div>
      <form class="modal-connect-form modal-form">
        <div class="formFields">
          <div>
            <input type="text" id="connectEmail" autocomplete="off"
             name="connectEmail"  placeholder="Archive.org email"/>
            <input type="text" autocomplete="off" class="fake"
             name="connectEmail_fake" placeholder="Archive.org email"/>
          </div>
          <div class="inputbr"></div>
          <div>
            <input type="password" id="connectPassword" autocomplete="off"
             name="connectPassword"  placeholder="Password"/>
           <input type="password" autocomplete="off" class="fake"
            name="connectPassword_fake" placeholder="Password"/>
          </div>

          <!-- data forwarded from the 1st form -->
          <input type="hidden" id="mainEmail" name="mainEmail" />
          <input type="hidden" id="mainPassword" name="mainPassword" />
        </div>
        <div>
          <button id="verifyAndConnect">Verify &amp; Connect</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="contentBody">
    <form id="register" class="login olform" name="register" method="post">

        $if form.note:
            <div class="note">$form.note</div>

        <div class="formElement">
            <div class="label"><label for="username">$_("Username")</label> <span class="smaller lighter"></span></div>

            <div class="input">
                <input type="text" class="required" id="username" name="username" value="$(form.username.value or query_param('username'))" autocapitalize="off" autocorrect="off"/>
                <span class="invalid clearfix" htmlfor="username">$form.username.note</span>
            </div>
        </div>

        <div class="formElement">
            <div class="label"><label for="password">$_("Password")</label> <span class="smaller lighter"></span></div>
            <div class="input">
                <input type="password" class="required"  id="password" name="password" value="$form.password.value" />
                <span class="invalid clearfix" htmlfor="password">$form.password.note</span>
            </div>
        </div>

        <div class="formElement">
            <div class="input">
                <input name="remember" type="checkbox" id="remember" />
                <label for="remember" class="small">Remember me</label>
            </div>
        </div>
        <input type="hidden" id="redirect" value="$form.redirect.value" name="redirect" />

        <div class="clearfix"></div>

        <div class="formElement bottom">
            <br/>
            <input value="$_('Log In')" type="submit" class="login-submit" name="login" title="$_('Log In')"/>
            &nbsp;
            <a href="javascript:;" onclick="history.go(-1);" class="attn">$_("Cancel")</a>
        </div>
        <div class="formElement">
            <div class="label"></div>
            <div class="input smaller">$:_('<a href="/account/password/forgot">Forgotten your username or password</a>?')
            <br/><br/>
            $:_('Not a member of Open Library? <a href="/account/create">Sign up now</a>.')</div>
        </div>
    </form>
</div>

<script>

  \$(function(){

      var bridge = {
           linked: false
      };

      var resetModal = function() {
          \$('#migrateModal').hide();
          \$('.modal-header-copy-a').show();
          \$('.modal-header-copy-b').hide();
          \$('.modal-header-copy-c').hide();
          \$('.modal-connect-form').hide();
          \$('.modal-create-form').hide();
          \$('.modal-option').show();
      }

      \$('.modal-x').click(function(event) {
          resetModal();
      });

      // Render the "Connect Accounts" form
      \$('#linkAccounts').click(function(event) {
          \$('.modal-option').hide();
          \$('.modal-header-copy-a').fadeOut(function() {
              \$('.modal-header-copy-b').fadeIn();
          });
          \$('.modal-connect-form').show()
      });

      // Render the "Create Account" form
      \$('#createAccount').click(function(event) {
          \$('.modal-option').hide();
          \$('.modal-header-copy-a').fadeOut(function() {
              \$('.modal-header-copy-c').fadeIn();
          });

          bridge.email = \$('#username').val();
          \$('.modal-create-form').show()
      });

      \$('#verifyAndCreate').click(function(event) {
          // if IA, check if OL

          // ajax to see if credentials verify
          // \$('#register').submit();
      });

      \$('#verifyAndConnect').click(function(event) {
          // XXX change to OL /account/verify_usernames
          var url = 'https://api.archivelab.org/auth';
          \$.ajax({
              type: "POST",
              data: {
                  email: \$('#connectEmail').val(),
                  password: \$('#connectPassword').val(),
              },
              url: url,
              dataType: "json",
              success: function(result) {
                  console.log(result);
                  if (result.email) {
                      // XXX TODO: ajax 2 for
                      bridge.email = result.email;
                      \$('#register').submit();
                  } else {
                      alert("Error");
                      \$('#connectEmail').val('');
                      \$('#connectPassword').val('');
                  }
              }
          })
      });

      \$('#register').submit(function(event) {
          if (!bridge.authenticated) {
              event.preventDefault();
              var url = '/account/audit';
              \$.ajax({
                  type: "POST",
                  data: {
                      email: \$('#username').val(),
                      password: \$('#password').val()
                  },
                  url: url,
                  dataType: "json",
                  success: function(result) {
                      console.log(result);
                      if (result.error) {
                          // TODO: set html to reflect error
                          alert(result.error);
                      } else if (typeof(result.linked) == 'undefined') {
                          alert("API Error");
                      } else {
                          bridge.authenticated = true;
                          if (!bridge.linked) {
                              if (Boolean(result.has_ia) !== Boolean(result.has_ol)){
                                  \$('#migrateModal').show();
                              } else {
                                  bridge.email = result.email;
                              }
                          } else {
                              bridge.linked = true;
                              \$('#register').submit();
                          }
                      }
                  }
              })
          }
      })
  });
</script>
