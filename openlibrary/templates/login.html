$def with (form)

$var title: $("Log In")

<div id="contentHead">
    <h1>$_("Log In")</h1>
</div>

<script type="text/javascript">
//\$().ready(passwordMask);
//\$().ready(validateForms);
//\$().ready(validateLogin);
</script>


<div id="migrateModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-x">&#x2715;</div>
      <div class="modal-icon">
        <img  src="https://archive.org/images/logo_arches.png"/>
      </div>
      <div class="modal-header-copy">
        <h2>Connect Accounts</h2>
        <p class="modal-header-copy-a">
          Your <a class="linked-service" href=""></a> account must be connected to an <a class="unlinked-service" href=""></a> account to continue. Do you have one already?
        </p>
        <p class="modal-header-copy-b">Verify your <a class="unlinked-service" href=""></a> credentials and proceed to login.</p>
        <p class="modal-header-copy-c">Choose a username for your new <a class="unlinked-service" href=""></a> account.</p>
      </div>
    </div>

    <div class="modal-body">
      <ul class="modal-option">
        <li><a id="linkAccounts">Yes, connect my <span class="unlinked-service"></span> account.</a></li>
        <li><a id="createAccount">No, create one for me.</a></li>
      </ul>
      <div class="modal-create-form modal-form">
        <div class="formFields">
            <input type="text" id="connectUsername" autocomplete="off"
             name="createUsername" placeholder="Username"/>
        </div>
        <div>
          <button id="verifyAndCreate">Verify &amp; Create</button>
        </div>
      </div>
      <div class="modal-connect-form modal-form">
        <div class="formFields">
          <div>
            <input type="text" id="connectEmail" autocomplete="off"
             name="connectEmail"  placeholder="Email"/>
            <input type="text" autocomplete="off" class="fake"
             name="connectEmail_fake" placeholder="Email"/>
          </div>
          <div class="inputbr"></div>
          <div>
            <input type="password" id="connectPassword" autocomplete="off"
             name="connectPassword"  placeholder="Password"/>
           <input type="password" autocomplete="off" class="fake"
            name="connectPassword_fake" placeholder="Password"/>
          </div>

          <!-- data forwarded from the 1st form -->
          <input type="hidden" id="mainEmail" name="mainEmail" />
          <input type="hidden" id="mainPassword" name="mainPassword" />
        </div>
        <div>
          <button id="verifyAndConnect">Verify &amp; Connect</button>
          <p><a class="forgot-unlinked">Forgot Password?</a></p>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="contentBody">
    <form id="register" class="login olform" name="register" method="post">

        $if form.note:
            <div class="note">$form.note</div>

        <div class="formElement">
            <div class="label"><label for="username">$_("Email")</label> <span class="smaller lighter"></span></div>

            <div class="input">
                <input type="text" class="required" id="username" name="username" value="$(form.username.value or query_param('username'))" placeholder="email" autocapitalize="off" autocorrect="off"/>
                <span class="invalid clearfix" htmlfor="username">$form.username.note</span>
            </div>
        </div>

        <div class="formElement">
            <div class="label"><label for="password">$_("Password")</label> <span class="smaller lighter"></span></div>
            <div class="input">
                <input type="password" class="required" placeholder="Password" id="password" name="password" value="$form.password.value" />
                <span class="invalid clearfix" htmlfor="password">$form.password.note</span>
            </div>
        </div>

        <div class="formElement">
            <div class="input">
                <input name="remember" type="checkbox" id="remember" />
                <label for="remember" class="small">Remember me</label>
            </div>
        </div>

        <input type="hidden" id="redirect" value="$form.redirect.value" name="redirect" />
        <input type="hidden" id="bridgeUsername" value="" name="bridgeUsername" />
        <input type="hidden" id="bridgeEmail" value="" name="bridgeEmail" />
        <input type="hidden" id="bridgePassword" value="" name="bridgePassword" />
        <input type="hidden" id="bridgeService" value="" name="redirect" />

        <div class="clearfix"></div>

        <div class="formElement bottom">
            <br/>
            <input value="$_('Log In')" type="submit" class="login-submit" name="login" title="$_('Log In')"/>
            &nbsp;
            <a href="javascript:;" onclick="history.go(-1);" class="attn">$_("Cancel")</a>
        </div>
        <div class="formElement">
            <div class="label"></div>
            <div class="input smaller">$:_('<a href="/account/password/forgot">Forgotten your username or password</a>?')
            <br/><br/>
            $:_('Not a member of Open Library? <a href="/account/create">Sign up now</a>.')</div>
        </div>
    </form>
</div>

<script>

  \$(function(){

      var bridge = {
           linked: false
      };

      var services = {
	  'ia': {
	      'url': 'archive.org',
	      'name': 'Internet Archive',
	      'opposite': 'ol',
	      'forgot': '/account/login.forgotpw.php'

	  },
	  'ol': {
	      'url': 'openlibrary.org',
	      'name': 'Open Library',
	      'opposite': 'ia',
	      'forgot': '/account/password/forgot'
	  }
      };

      var resetModal = function() {
          \$('#migrateModal').hide();
          \$('.modal-header-copy-a').show();
          \$('.modal-header-copy-b').hide();
          \$('.modal-header-copy-c').hide();
          \$('.modal-connect-form').hide();
          \$('.modal-create-form').hide();
	  \$('#bridgeUsername').val('');
	  \$('#bridgeEmail').val('');
	  \$('#bridgePassword').val('');
	  \$('#bridgeService').val('');
          \$('.modal-option').show();
      }

      \$('.modal-x').click(function(event) {
          resetModal();
      });

      // Render the "Connect Accounts" form
      \$('#linkAccounts').click(function(event) {
          \$('.modal-option').hide();
          \$('.modal-header-copy-a').fadeOut(function() {
              \$('.modal-header-copy-b').fadeIn();
          });
          \$('.modal-connect-form').show()
      });

      // Render the "Create Account" form
      \$('#createAccount').click(function(event) {
          \$('.modal-option').hide();
          \$('.modal-header-copy-a').fadeOut(function() {
              \$('.modal-header-copy-c').fadeIn();
          });

          bridge.email = \$('#username').val();
          \$('.modal-create-form').show()
      });

      var authenticate = function(email, password, callback) {
          var url = '/account/audit';
          \$.ajax({
              type: "POST",
              data: {
                  email: email,
                  password: password
              },
              url: url,
              dataType: "json",
              success: function(result) {
		  return callback(result);
	      }
	  });
      };

      var check_username_available = function(email, password, callback) {
          var url = '/account/check_username_available';
          \$.ajax({
              type: "POST",
              data: {
                  email: email,
                  password: password
              },
              url: url,
              dataType: "json",
              success: function(result) {
		  return callback(result);
	      }
	  });
      };

      \$('#verifyAndCreate').click(function(event) {
	  check_username_available(\$('#createUsername').val(), function(result) {
	      console.log('verify and create');
              console.log(result);
	      if (result.authenticated) {
		  bridge.service = result.authenticated;
		  if (!result.username) {
		      alert("Invalid username");
		  }
		  bridge.username = result.username;

		  \$('#bridgeService').val(bridge.service);
		  \$('#bridgeUsername').val(bridge.username);
		  // \$('#register').submit();
	      }
	  });
      });

      \$('#verifyAndConnect').click(function(event) {
	  authenticate(\$('#connectEmail').val(), \$('#connectPassword').val(), function(result) {
	      console.log('verify and connect');
              console.log(result);
	      if (result.authenticated) {
		  bridge.service = result.authenticated;
		  bridge.email = \$('#connectEmail').val();
		  bridge.password = \$('#connectPassword').val();

		  \$('#bridgeService').val(bridge.service);
		  \$('#bridgeEmail').val(bridge.email);
		  \$('#bridgePassword').val(bridge.password);
                  \$('#register').submit();
              } else {
                  alert("Error");
                  \$('#bridgeEmail').val('');
                  \$('#bridgePassword').val('');
              }
	  });
      });
      
      var setService = function(service) {
	 var linked = services[service];
	 var unlinked = services[linked.opposite];
	 \$('.linked-service').html(linked.name);
	 \$('a.linked-service').attr('href', 'https://' + linked.url);
	 \$('.unlinked-service').html(unlinked.name);
	 \$('a.unlinked-service').attr('href', 'https://' + unlinked.url);
	 \$('.modal-body .unlinked-service').html(unlinked.url);
	 \$('.forgot-unlinked').attr('href', 'https://' + unlinked.url + unlinked.forgot);
	 \$('.forgot-unlinked').html('Forgot your ' + unlinked.name + ' password?');
      }

      \$('#register').submit(function(event) {
          if (!bridge.authenticated || !bridge.has_ia || !bridge.has_ol) {
              event.preventDefault();
	      authenticate(\$('#username').val(), \$('#password').val(), function(result) {
                  console.log(result);
                  if (result.error) {
                      \$('.note').remove();
                      \$('#register').prepend('<div class="note">' + result.error + '</div>');
                  } else if (typeof(result.link) == 'undefined') {
                      \$('.note').remove();
                      \$('#register').prepend('<div class="note">A network error occured. Please try again later</div>');
                  } else {
                      bridge.authenticated = true;
                      bridge.service = result.authenticated;

                      if (!bridge.link) {
                          if (Boolean(result.has_ia) !== Boolean(result.has_ol)){
			      setService(bridge.service);
                              \$('#migrateModal').show();
                          } else {
                              bridge.email = result.email;
			      \$('#register').submit();
                          }
                      } else {
                          bridge.link = true;
                          \$('#register').submit();
                      }
                  }
	      });
          }
	  console.log(bridge);
      })
  });
</script>
